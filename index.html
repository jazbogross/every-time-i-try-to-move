<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>every time I try to move</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
<script src="https://player.vimeo.com/api/player.js"></script>    
<div id="text-container">
    <div class="block" id="container">
        <ul data-current="0">
            <li><p>spectactor: where do I begin?</p></li>
            <li><p>spectactor: where do you begin?</p></li>
            <li><p>spectactor: I</p></li>
            <li><p>spectactor: am</p></li>
            <li><p>spectactor: in a disrupted state</p></li>
            <li><p>spectactor: of</p></li>
            <li><p>spectactor: being</p></li>
            <li><p>spectactor: breathing</p></li>
            <li><p>spectactor: moving</p></li>
            <li><p><i>the spectactor takes a seat. as if they were seated on a warm stone in the early autumn sun, they place their body in a relaxed position, feet apart, arms resting in their lap, relaxed shoulders and face muscles. the spectactor takes a deep breath in and while they slowly exhale, they turn their head to the right.</i></p></li>
            <li><p>spectactor: everytime I try to move</p></li>
            <li><p>spectactor: I loose track of my destination</p></li>
            <li><p>spectactor: I loose track of where I came from</p></li>
            <li><p>spectactor: ruined</p></li>
            <li><p>spectactor: my body keeps moving</p></li>
            <li><p>spectactor: in my mind</p></li>
            <li><p>spectactor: I am moving</p></li>
            <li><p>spectactor: you are not ruined</p></li>
            <li><p>spectactor: I am a fragment</p></li>
            <li><p>spectactor: stay</p></li>
            <li><p>spectactor: is my body not moving</p></li>
            <li><p>spectactor: ruins?</p></li>
            <li><p>spectactor: now is not the time to give up on your loved ones</p></li>
            <li><p>spectactor: moving through time</p></li>
            <li><p>spectactor: I am a fragment</p></li>
            <li><p>spectactor: of a</p></li>
            <li><p>spectactor: we</p></li>
            <li><p>spectactor: we are</p></li>
            <li><p>spectactor: unstable</p></li>
            <li><p>spectactor: connections</p></li>
            <li><p>spectactor: hearts</p></li> 
            <li><p>spectactor: beating</p></li> 
            <li><p>spectactor: to the same</p></li>
            <li><p>spectactor: lost</p></li>
            <li><p>spectactor: pixels</p></li>
            <li><p>spectactor: of</p></li>
            <li><p>spectactor: lungs</p></li>
            <li><p>spectactor: breathing in</p></li>
            <li><p>spectactor: not enough cables in this world</p></li>
            <li><p>spectactor: to carry</p></li>
            <li><p>spectactor: my</p></li>
            <li><p>spectactor: warm embrace</p></li>
            <li><p>spectactor: your skin is</p></li>
            <li><p>spectactor: reaching</p></li>
            <li><p>spectactor: I</p></li>
            <li><p><i>the spectactor takes a seat. as if they were seated on a warm stone in the early autumn sun, they place their body in a relaxed position, feet apart, arms resting in their lap, relaxed shoulders and face muscles. the spectactor takes a deep breath in and while they slowly exhale, they look straight ahead.</i></p></li>
            <li><p>spectactor: do I end where my voice ends?</p></li>
            <li><p>spectactor: step into our story</p></li>
            <li><p>spectactor: where do you begin?</p></li>
            <li><p>spectactor: am I not moving?</p></li>
            <li><p>spectactor: are we not</p></li> 
            <li><p>spectactor: moving</p></li>
            <li><p>spectactor: through time</p></li>
            <li><p>spectactor: resonating</p></li> 
            <li><p>spectactor: in</p></li>
            <li><p>spectactor: the stories</p></li>
            <li><p>spectactor: of</p></li>
            <li><p>spectactor: each other</p></li>
            <li><p>spectactor: are we not</p></li>
            <li><p>spectactor: where do I begin?</p></li>
            <li><p>spectactor: ruins</p></li>
            <li><p>spectactor: where do I end?</p></li>
            <li><p>spectactor: where do you end?</p></li>
            <li><p>spectactor: do I end in you?</p></li>
            <li><p>spectactor: warm ruins</p></li>
            <li><p>spectactor: do you end in me?</p></li>
            <li><p>spectactor: do I end in you?</p></li>
            <li><p>spectactor: embrace a random object</p></li>
            <li><p><i>the spectactor takes a seat. as if they were seated on a warm stone in the early autumn sun, they place their body in a relaxed position, feet apart, arms resting in their lap, relaxed shoulders and face muscles. the spectactor takes a deep breath in and while they slowly exhale, they turn their head to the left.</i></p></li>
            <li><p>spectactor: do I end where my voice ends?</p></li>
            <li><p>spectactor: do I begin where my voice ends?</p></li>
            <li><p>spectactor: do you begin in me?</p></li>
            <li><p>spectactor: do I begin in you?</p></li>
            <li><p>spectactor: do you begin in me?</p></li>
            <li><p>spectactor: do I begin in you?</p></li>
        </ul>
    </div>
</div>

<div id="background"></div>
<div id="vimeo-container"></div>
<canvas id="canvas" style="display: none;"></canvas>
  
<div id="welcome-screen">
  <div><p>every time I try to move</p></div>
  <div><button id="enterPerformance">enter</button></div>
</div>

<script>
const html = document.querySelector('html');
const canvas = document.getElementById('canvas');
const welcomeScreen = document.getElementById('welcome-screen');
const video = document.createElement('video');
const vimeoContainer = document.querySelector('#vimeo-container');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const vimeoID = '878938745';
let domHeight = window.innerHeight;
let domWidth = window.innerWidth;
let visibleTime = 0;
let randomNumber = 50;
let vimeoVisible = false;
let canvasVisible = true;
let lastTimeUpdate = Date.now();
let isBuffering = false;

vimeoContainer.style.display = 'none';
canvas.style.display = 'block';
video.setAttribute.autoplay;
video.setAttribute.muted;

const vimeoOptions = {
    id: vimeoID,
    width: domWidth,
    loop: true,
    controls: false, // Hide controls
    autoplay: true,
    muted: true
};

const vimeoPlayer = new Vimeo.Player(vimeoContainer, vimeoOptions);

vimeoPlayer.on('play', function() {
    vimeoContainer.style.display = 'block';
});

vimeoPlayer.on('timeupdate', function(data) {
  const now = Date.now();
  const timeSinceLastUpdate = now - lastTimeUpdate;

  if (timeSinceLastUpdate > 2000) { // 2000 milliseconds or 2 seconds
    if (!isBuffering) {
      isBuffering = true;
      vimeoContainer.style.display = 'none';
    }
  } else {
    if (isBuffering) {
      isBuffering = false;
      vimeoContainer.style.display = 'block';
    }
  }

  lastTimeUpdate = now;
});

async function setupCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' },
    });
    video.srcObject = stream;
    video.muted = true; // Mute the video
    video.playsInline = true; // Allows inline playback
    video.addEventListener('loadedmetadata', () => {
      video.play(); // Play video after metadata has loaded
    });

    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    console.log('ctx: ' + ctx);
    const draw = () => {
//    console.log("Draw function called");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const threshold = 40;
      const feather = 50;

      for (let i = 0; i < data.length; i += 4) {
        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;

        if (brightness < threshold) {
          data[i + 3] = 0;
        } else if (brightness < threshold + feather) {
          data[i + 3] = 255 * ((brightness - threshold) / feather);
        }
      }

      ctx.putImageData(imageData, 0, 0);
      requestAnimationFrame(draw);
    };

    draw();
    hideWelcome();
  } catch (err) {
    console.error("An error occurred: ", err);
  }
}

async function infinityScroll() {
    document.addEventListener( "DOMContentLoaded", function() {
    console.log('DOM Content loaded. Yayyyyy')
    var div = document.getElementById( "container" );
    div.addEventListener( "scroll", function() {
        console.log('You are scrolling!')
        var max_scroll = this.scrollHeight - this.clientHeight;
        var current_scroll = this.scrollTop;
        var bottom = 100;
            if ( current_scroll + bottom >= max_scroll ) {
                var ul = document.getElementsByTagName( "ul" )[ 0 ];
                var current = parseInt( ul.dataset.current, 10 );
                var li = document.getElementsByTagName( "li" )[ current ];
                var new_li = li.cloneNode( true );
                ul.appendChild( new_li );
                ul.dataset.current = current + 1; 
            }
        });
    });	
}

const turnOffLights = (minuteToRun) => {
  setInterval(() => {
    const date = new Date();
    if (date.getMinutes() === minuteToRun && date.getSeconds() === 0) {
      console.log(`Triggered at ${date}`);
      html.style.transition = 'all 1s ease';
      html.style.filter = 'brightness(100%)';
      html.style.filter = 'brightness(0%)';
    }
  }, 1000);
};

const turnOnLights = (minuteToRun) => {
  setInterval(() => {
    const date = new Date();
    if (date.getMinutes() === minuteToRun && date.getSeconds() === 0) {
      console.log(`Triggered at ${date}`);
      html.style.filter = 'brightness(100%)';
    }
  }, 1000);
};

const showVimeo = (x) => {
  setInterval(() => {
    const random100 = Math.random() * 100;
    if (randomNumber > random100 && vimeoVisible == false) {
      vimeoContainer.style.display = 'block';
      vimeoVisible = true;
      chancePercentage();
      console.log(randomNumber);
    } else {
      console.log(`showVimeo function did not run. Random number ${random100.toFixed(2)} is greater than ${randomNumber} or it was already playing`);
    }
  }, x * 1000);
};

const showFace = (x) => {
  setInterval(() => {
    const random100 = Math.random() * 100;
    if (randomNumber > random100 && canvasVisible == false) {
        canvas.style.display = 'block';
        console.log("Canvas Initialized");
        console.log('stream: ' + video.srcObject);
        canvasVisible = true
    } else {
      console.log(`showFace function did not run. Random number ${random100.toFixed(2)} is greater than ${randomNumber} OR it was already visible`);
    }
  }, x * 1000);
};

const hideVideos = (x) => {
  setInterval(() => {
    if (vimeoVisible || canvasVisible) {
        visibleTime += x;

        let logProb;

        if (visibleTime <= 60) {
            // Slowly rising probability in the first minute
            logProb = 0.05 * visibleTime;
        } else if (visibleTime <= 240) {
            // Faster rise in probability from 5% to 100% between 1 and 4 minutes
            logProb = 5 + 30 * ((visibleTime - 60) / (240 - 60));
        } else {
            // 100% probability after 4 minutes
            logProb = 100;
        }

        const chanceOfOff = Math.random() * 100;
        console.log('visible time ' + visibleTime);
        // console.log('logProb ' + logProb);
        // console.log('chance that video will turn off ' + chanceOfOff + '%');

        if (logProb > chanceOfOff) {
            canvas.style.display = 'none';
            vimeoContainer.style.display = 'none';
            vimeoVisible = false;
            canvasVisible = false;
            visibleTime = 0;
            console.log(`hid the videos`);
        } else {
            console.log(`Video(s) running but didn't hide`);
        }
    } else {
        console.log(`No videos are running`);
        visibleTime = 0;
    }
  }, x * 1000);
};

function hideControls() {
    vimeoPlayer.getPaused().then(function(paused) {
        if (!paused) {
            vimeoPlayer.unload().then(function() {
                vimeoPlayer.loadVideo(vimeoID).then(function(id) {
                    vimeoPlayer.setVolume(0);
                    vimeoPlayer.setControls(false);
                    vimeoPlayer.play();
                });
            });
        }
    });
}

const chancePercentage = () => randomNumber = Math.floor(Math.random() * 51) + 50;

function hideWelcome() {
  welcomeScreen.style.display = 'none';
  canvas.style.display = 'none';
  vimeoContainer.style.display = 'none';
  vimeoVisible = false;
  canvasVisible = false;
  visibleTime = 0;
}

document.getElementById('enterPerformance').addEventListener('click', setupCamera);

// Initialize
infinityScroll();
showVimeo(363);
showFace(523);
hideVideos(5);
turnOffLights(37);
turnOnLights(40);
hideControls();


</script>

</body>
</html>
